@model CryptoInvestment.ViewModels.CustomerConfiguration.CustomerConfigurationViewModel

@{
    Layout = "~/Views/Shared/_Dashboard.cshtml";
    ViewBag.Title = "GHR I & T";
    
    var activeTab = Context.Request.Query["activeTab"].ToString();
    if (string.IsNullOrEmpty(activeTab))
    {
        activeTab = "change-password";
    }
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil del Usuario</title>
    
    @section Styles {
        <environment names="Development,Staging,Production">
            <link rel="stylesheet" href="~/lib/iCheck/custom.css" />
            <link rel="stylesheet" href="~/lib/steps/jquery.steps.css" />
            <link rel="stylesheet" href="~/css/intlTelInput.css">
            <link rel="stylesheet" href="~/lib/sweetalert/dist/sweetalert.css" />
            <link rel="stylesheet" href="~/lib/iCheck/custom.css" />
            <link rel="stylesheet" href="~/lib/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css" />
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/css/intlTelInput.css">
        </environment>
    }
</head>
<body>
<div class="container page-container">
    <h3 class="text-center m-t">Perfil del Usuario</h3>

    <!-- Tabs for navigation -->
    <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item">
            <a class="nav-link @(activeTab == "change-password" ? "active" : "")" id="change-password-tab" data-bs-toggle="tab" href="#change-password" role="tab">
                Cambiar Contraseña
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(activeTab == "security-questions" ? "active" : "")" id="security-questions-tab" data-bs-toggle="tab" href="#security-questions" role="tab">
                Preguntas de Seguridad
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(activeTab == "subir-documentos" ? "active" : "")" id="subir-documentos-tab" data-bs-toggle="tab" href="#subir-documentos" role="tab">
                Documentos
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link @(activeTab == "ben" ? "active" : "")" id="ben-tab" data-bs-toggle="tab" href="#ben" role="tab">
                Beneficiarios
            </a>
        </li>
    </ul>

    <!-- Tab content -->
    <div class="tab-content">
        <!-- Change Password Tab: Se marca activo y visible -->
        <div class="tab-pane fade @(activeTab == "change-password" ? "show active" : "")" id="change-password" role="tabpanel">
            <div class="d-flex align-items-center justify-content-center flex-column" style="height: 50vh;">
                <div class="col-md-6">
                    <div class="ibox ">
                        <div class="ibox-content">
                            <form class="m-t" asp-action="ResetPassword" asp-controller="CustomerConfiguration" method="post">
                                <input type="hidden" asp-for="CustomerId"/>
                                <div class="row" id="pwd-container1">
                                    <div class="col-sm-12">
                                        <div class="form-group">
                                            <label for="password2">Confirmar Contraseña</label>
                                            <input asp-for="ResetPassword.CurrentPassword" type="password" class="form-control" id="password" placeholder="Contraseña Actual">
                                            <span class="text-danger">@Html.ValidationMessageFor(model => model.ResetPassword.CurrentPassword)</span>
                                        </div>
                                        <div class="form-group">
                                            <label for="password1">Nueva Contraseña</label>
                                            <input asp-for="ResetPassword.Password" type="password" class="form-control example1" id="password1" placeholder="Contraseña">
                                            <span class="text-danger">@Html.ValidationMessageFor(model => model.ResetPassword.Password)</span>
                                        </div>
                                        <div class="form-group">
                                            <label for="password2">Confirmar Contraseña</label>
                                            <input asp-for="ResetPassword.ConfirmPassword" type="password" class="form-control" id="password2" placeholder="Confirmar Contraseña">
                                            <span class="text-danger">@Html.ValidationMessageFor(model => model.ResetPassword.ConfirmPassword)</span>
                                        </div>
                                        <div class="form-group">
                                            <div class="pwstrength_viewport_progress"></div>
                                        </div>
                                    </div>
                                </div>

                                <button type="submit" class="btn btn-primary block full-width m-b">Actualizar Contraseña</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Security Questions Tab -->
        <div class="tab-pane fade @(activeTab == "security-questions" ? "show active" : "")" id="security-questions" role="tabpanel">
            <div class="wrapper animated fadeInRight" style="padding: 80px 10px 40px;">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="ibox">
                            <div class="ibox-content">
                                <form id="securityQuestionsForm" asp-action="ChangeSecurityQuestions" asp-controller="CustomerConfiguration" method="post" class="wizard-big">
                                    <input type="hidden" asp-for="CustomerId" />

                                    <h1>Primera Pregunta</h1>
                                    <fieldset>
                                        <h2 class="m-b-md">Primera Pregunta de Seguridad</h2>
                                        <div class="form-group">
                                            <select asp-for="SetSecurityQuestion.FirstQuestionId" id="FirstQuestionId" class="form-control" style="border-radius: 6px; height: 40px" required>
                                                <option value="">Seleccione una pregunta</option>
                                                @foreach (var item in Model.SetSecurityQuestion.SecurityQuestions)
                                                {
                                                <option value="@item.IdSecurityQuestion">
                                                    @item.Question
                                                </option>
                                                }
                                            </select>
                                            <span class="text-danger" asp-validation-for="SetSecurityQuestion.FirstQuestionId"></span>
                                        </div>
                                        <div class="form-group">
                                            <input asp-for="SetSecurityQuestion.FirstQuestionAnswer" type="text" class="form-control" placeholder="Respuesta de la pregunta 1" required />
                                            <span class="text-danger" asp-validation-for="SetSecurityQuestion.FirstQuestionAnswer"></span>
                                        </div>
                                    </fieldset>

                                    <h1>Segunda Pregunta</h1>
                                    <fieldset>
                                        <h2 class="m-b-md">Segunda Pregunta de Seguridad</h2>
                                        <div class="form-group">
                                            <select asp-for="SetSecurityQuestion.SecondQuestionId" id="SecondQuestionId" class="form-control" style="border-radius: 6px; height: 40px" required>
                                                <option value="">Seleccione una pregunta</option>
                                                @foreach (var item in Model.SetSecurityQuestion.SecurityQuestions)
                                                {
                                                <option value="@item.IdSecurityQuestion">
                                                    @item.Question
                                                </option>
                                                }
                                            </select>
                                            <span class="text-danger" asp-validation-for="SetSecurityQuestion.SecondQuestionId"></span>
                                        </div>
                                        <div class="form-group">
                                            <input asp-for="SetSecurityQuestion.SecondQuestionAnswer" type="text" class="form-control" placeholder="Respuesta de la pregunta 2" required />
                                            <span class="text-danger" asp-validation-for="SetSecurityQuestion.SecondQuestionAnswer"></span>
                                        </div>
                                    </fieldset>

                                    <h1>Tercera Pregunta</h1>
                                    <fieldset>
                                        <h2 class="m-b-md">Tercera Pregunta de Seguridad</h2>
                                        <div class="form-group">
                                            <select asp-for="SetSecurityQuestion.ThirdQuestionId" id="ThirdQuestionId" class="form-control" style="border-radius: 6px; height: 40px" required>
                                                <option value="">Seleccione una pregunta</option>
                                                @foreach (var item in Model.SetSecurityQuestion.SecurityQuestions)
                                                {
                                                <option value="@item.IdSecurityQuestion">
                                                    @item.Question
                                                </option>
                                                }
                                            </select>
                                            <span class="text-danger" asp-validation-for="SetSecurityQuestion.ThirdQuestionId"></span>
                                        </div>
                                        <div class="form-group">
                                            <input asp-for="SetSecurityQuestion.ThirdQuestionAnswer" type="text" class="form-control" placeholder="Respuesta de la pregunta 3" required />
                                            <span class="text-danger" asp-validation-for="SetSecurityQuestion.ThirdQuestionAnswer"></span>
                                        </div>
                                    </fieldset>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Document Tab -->
        <div class="tab-pane fade @(activeTab == "subir-documentos" ? "show active" : "")" id="subir-documentos" role="tabpanel">
            <div class="row text-center">
                <div>
                    @if (Model.CustomerPic != null)
                    {
                        <div style="display: flex; flex-direction: column; gap: 10px; align-items: center;">
                            @if (Model.CustomerPic.PictureFront != null)
                            {
                                <img class="m-b" src="data:image/png;base64,@Convert.ToBase64String(Model.CustomerPic.PictureFront)"
                                     alt="Imagen Frontal"
                                     width="300" height="200"/>
                            }

                            @if (Model.CustomerPic.PictureBack != null)
                            {
                                <img class="m-b" src="data:image/png;base64,@Convert.ToBase64String(Model.CustomerPic.PictureBack)"
                                     alt="Imagen Trasera"
                                     width="300" height="200"/>
                            }
                        </div>
                    }
                    else
                    {
                        <div>
                            <h2>No ha sido agregado ningún documento de identificacíon</h2>
                            <button type="button" class="btn btn-primary document-btn m-b d-flex justify-content-center align-items-center"
                                    style="height: 100px; width: 200px">
                                <i class="fa fa-id-card fa-4x"></i>
                            </button>
                        </div>
                    }
                    
                    @if (Model.CustomerPic != null)
                    {
                        <div class="d-inline-flex">
                            <button class="btn btn-danger m-b d-flex justify-content-center align-items-center m-r demo5">Eliminar documentos</button>
                            <button type="button" class="btn btn-primary m-b d-flex justify-content-center align-items-center" data-toggle="modal" data-target="#myModal2">
                                Validar Documentos
                            </button>
                        </div>
                    }
                    else
                    {
                        <button type="button" class="btn btn-primary m-b d-flex justify-content-center align-items-center" data-toggle="modal" data-target="#myModal1">
                            Agregar documento
                        </button>
                    }
                    <div class="modal inmodal" id="myModal1" tabindex="-1" role="dialog" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content animated fadeIn">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal">
                                        <span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
                                    </button>
                                    <h3 class="modal-title">Seleccione el tipo de documento</h3>
                                </div>
                                <div class="modal-body">
                                    <form id="documentForm" class="m-t" asp-action="UpdateImages" asp-controller="CustomerConfiguration" method="post">
                                        <input type="hidden" asp-for="CustomerId"/>
                                        <div class="d-flex flex-column align-items-start">
                                            <div class="i-checks">
                                                <label>
                                                    <div>
                                                        <label>
                                                            <div class="iradio_square-green" style="position: relative;"><input type="radio" checked="" value="passport" name="documentType" style="position: absolute; opacity: 0;"><ins class="iCheck-helper" style="position: absolute; top: 0%; left: 0%; display: block; width: 100%; height: 100%; margin: 0px; padding: 0px; background: rgb(255, 255, 255); border: 0px; opacity: 0;"></ins></div> <i></i> Pasaporte </label></div>
                                                </label>
                                            </div>
                                            <div class="i-checks">
                                                <label>
                                                    <div>
                                                        <label>
                                                            <div class="iradio_square-green" style="position: relative;"><input type="radio" checked="" value="license" name="documentType" style="position: absolute; opacity: 0;"><ins class="iCheck-helper" style="position: absolute; top: 0%; left: 0%; display: block; width: 100%; height: 100%; margin: 0px; padding: 0px; background: rgb(255, 255, 255); border: 0px; opacity: 0;"></ins></div> <i></i> Licencia de Conducción </label></div>
                                                </label>
                                            </div>
                                            <div class="i-checks">
                                                <label>
                                                    <div>
                                                        <label>
                                                            <div class="iradio_square-green" style="position: relative;"><input type="radio" checked="" value="identification" name="documentType" style="position: absolute; opacity: 0;"><ins class="iCheck-helper" style="position: absolute; top: 0%; left: 0%; display: block; width: 100%; height: 100%; margin: 0px; padding: 0px; background: rgb(255, 255, 255); border: 0px; opacity: 0;"></ins></div> <i></i> Idenrificación Oficial </label></div>
                                                </label>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
                                            <button type="submit" class="btn btn-primary">Continuar</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal inmodal" id="myModal2" tabindex="-1" role="dialog" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content animated fadeIn">
                                <div class="modal-header">
                                    <button type="button" class="close" data-dismiss="modal">
                                        <span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
                                    </button>
                                    <h3 class="modal-title">Enviar documentos a validación</h3>
                                </div>
                                <div class="modal-body">
                                    <div class="d-flex flex-column align-items-center">
                                        <h4>Si está satisfecho con los documentos, es momento de enviarlos a validación.</h4>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
                                        <a type="submit" class="btn btn-primary" href="@Url.Action("SendDocumentsToValidation", "CustomerConfiguration", new { token = Model.CustomerId })">Enviar</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Beneficiarios -->
        <div class="tab-pane fade @(activeTab == "ben" ? "show active" : "")" id="ben" role="tabpanel">
            <div class="wrapper wrapper-content animated fadeInRight">
                <div class="row">
                    <div class="col-lg-12">
                        <div class="ibox">
                            <div class="ibox-title">
                                <h5>Lista de Beneficiarios</h5>
                                <div class="ibox-tools">
                                    <button type="button" id="addBeneficiary" class="btn btn-primary btn-xs" data-toggle="modal" data-target="#myModal4">Agregar Beneficiario</button>
                                    <div class="modal inmodal" id="myModal4" tabindex="-1" role="dialog" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content animated fadeIn">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal">
                                                        <span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
                                                    </button>
                                                    <h4 class="modal-title" id="modalTitle">Nuevo Beneficiario</h4>
                                                </div>
                                                <div class="modal-body">
                                                    <form id="beneficiaryForm" class="m-t" asp-action="CreateBeneficiary" asp-controller="CustomerConfiguration" method="post">
                                                        <input type="hidden" asp-for="CustomerId"/>
                                                        <input type="hidden" id="beneficiaryId" asp-for="CustomerBeneficiary.Id"/>

                                                        <div class="form-group">
                                                            <input asp-for="CustomerBeneficiary.Name" id="name" class="form-control" placeholder="Nombre" required/>
                                                            <span class="text-danger">@Html.ValidationMessageFor(model => model.CustomerBeneficiary.Name)</span>
                                                        </div>

                                                        <div class="form-group">
                                                            <input asp-for="CustomerBeneficiary.ApePaternal" id="apePaternal" class="form-control" placeholder="Apellido Paterno" required/>
                                                            <span class="text-danger">@Html.ValidationMessageFor(model => model.CustomerBeneficiary.ApePaternal)</span>
                                                        </div>

                                                        <div class="form-group">
                                                            <input asp-for="CustomerBeneficiary.ApeMaternal" id="apeMaternal" class="form-control" placeholder="Apellido Materno"/>
                                                        </div>

                                                        <div class="form-group">
                                                            @Html.DropDownListFor(model => model.CustomerBeneficiary.RelationshipId,
                                                                new SelectList(Model.CustomerBeneficiary.CustomerRelationships, "RelationshipId", "Relationship"),
                                                                "Seleccione una relación",
                                                                new { @class = "form-control", required = "required", id = "relationship" })
                                                            <span class="text-danger">
                                                                @Html.ValidationMessageFor(model => model.CustomerBeneficiary.RelationshipId)
                                                            </span>
                                                        </div>

                                                        <div class="form-group">
                                                            <input type="tel" asp-for="CustomerBeneficiary.PhoneNumber" id="phone" class="form-control"/>
                                                            <span id="phone-error" class="validation-error" style="display: none; color: red;">
                                                                Ingrese un número de teléfono válido.
                                                            </span>
                                                            <span class="text-danger">@Html.ValidationMessageFor(model => model.CustomerBeneficiary.PhoneNumber)</span>
                                                        </div>

                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
                                                            <button type="submit" class="btn btn-primary" id="saveChangesButton">Guardar</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <button type="button" class="btn btn-primary btn-xs" data-toggle="modal" data-target="#myModal5">Asignación de porcentaje a beneficiarios</button>
                                    <div class="modal inmodal" id="myModal5" tabindex="-1" role="dialog" aria-hidden="true">
                                        <div class="modal-dialog">
                                            <div class="modal-content animated fadeIn">
                                                <div class="modal-header">
                                                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
                                                    <h4 class="modal-title">Asignación de porcentaje</h4>
                                                </div>
                                                <div class="modal-body">
                                                    <form id="beneficiaryPercentForm" class="m-t" asp-action="AssignBeneficiaryPercent" asp-controller="CustomerConfiguration" method="post">
                                                        <input type="hidden" asp-for="CustomerId"/>

                                                        <div class="table-responsive">
                                                            <table class="table table-hover issue-tracker">
                                                                <tbody id="beneficiaryTableBody">
                                                                @for (var i = 0; i < Model.CustomerBeneficiary.CustomerBeneficiaries.Count; i++)
                                                                {
                                                                <tr>
                                                                    <td>
                                                                        <h4 class="mb-0">
                                                                            @Model.CustomerBeneficiary.CustomerBeneficiaries[i].Nombre @Model.CustomerBeneficiary.CustomerBeneficiaries[i].ApePat
                                                                        </h4>
                                                                        <input type="hidden" asp-for="@Model.CustomerBeneficiary.CustomerBeneficiaries[@i].IdCustomerBeneficiary"/>
                                                                        <input type="hidden" asp-for="@Model.CustomerBeneficiary.CustomerBeneficiaries[@i].IdCustomer"/>
                                                                        <input type="hidden" asp-for="@Model.CustomerBeneficiary.CustomerBeneficiaries[@i].Nombre"/>
                                                                        <input type="hidden" asp-for="@Model.CustomerBeneficiary.CustomerBeneficiaries[@i].ApePat"/>
                                                                        <input type="hidden" asp-for="@Model.CustomerBeneficiary.CustomerBeneficiaries[@i].ApeMat"/>
                                                                        <input type="hidden" asp-for="@Model.CustomerBeneficiary.CustomerBeneficiaries[@i].RelationshipId"/>
                                                                        <input type="hidden" asp-for="@Model.CustomerBeneficiary.CustomerBeneficiaries[@i].Tel"/>
                                                                    </td>
                                                                    <td class="text-right mb-0">
                                                                        <div class="form-group">
                                                                            <input asp-for="@Model.CustomerBeneficiary.CustomerBeneficiaries[@i].Porcent" class="form-control m-t" placeholder="@Model.CustomerBeneficiary.CustomerBeneficiaries[i].Porcent" required/>
                                                                            <span class="text-danger">
                                                                                        @Html.ValidationMessageFor(model => model.CustomerBeneficiary.CustomerBeneficiaries[i].Porcent)
                                                                                    </span>
                                                                        </div>
                                                                    </td>
                                                                </tr>
                                                                }
                                                                </tbody>
                                                            </table>
                                                        </div>

                                                        <div class="modal-footer">
                                                            <button type="button" class="btn btn-white" data-dismiss="modal">Close</button>
                                                            <button type="submit" class="btn btn-primary">Save changes</button>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="ibox-content">
                                <div class="m-t m-b">
                                    <strong><span id="beneficiaryCount">@Model.CustomerBeneficiary.CustomerBeneficiaries.Count</span> Beneficiarios.</strong>
                                </div>

                                <div class="table-responsive">
                                    <table class="table table-hover issue-tracker">
                                        <tbody>
                                        @foreach (var beneficiary in Model.CustomerBeneficiary.CustomerBeneficiaries)
                                        {
                                            <tr>
                                                <td>@beneficiary.Nombre @beneficiary.ApePat</td>
                                                <td>@beneficiary.Tel</td>
                                                <td>
                                                    @{
                                                        var rel = Model.CustomerBeneficiary.CustomerRelationships
                                                            .FirstOrDefault(r => r.RelationshipId == beneficiary.RelationshipId)?.Relationship;
                                                    }
                                                    @rel
                                                </td>
                                                <td>
                                                    <span class="percentage-pie" data-value="@beneficiary.Porcent"></span>
                                                    @beneficiary.Porcent %
                                                </td>
                                                <td class="text-right">
                                                    <button type="button" class="btn btn-sm btn-white edit-btn"
                                                            data-id="@beneficiary.IdCustomerBeneficiary"
                                                            data-name="@beneficiary.Nombre"
                                                            data-ape-pat="@beneficiary.ApePat"
                                                            data-ape-mat="@beneficiary.ApeMat"
                                                            data-relationship="@beneficiary.RelationshipId"
                                                            data-phone="@beneficiary.Tel"
                                                            data-toggle="modal" data-target="#myModal4">
                                                        <i class="fa fa-pencil"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-danger delete-btn demo4"
                                                            data-customer-id="@Model.CustomerId"
                                                            data-beneficiary-id="@beneficiary.IdCustomerBeneficiary"
                                                            data-percent="@beneficiary.Porcent">
                                                        <i class="fa fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

@section Scripts {
    <environment names="Development,Staging,Production">
        <script src="~/lib/jquery-validation/dist/jquery.validate.min.js"></script>
        <script src="~/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
        <script src="~/lib/steps/jquery.steps.min.js"></script>
        <script src="~/lib/pwstrength/pwstrength-bootstrap.min.js"></script>
        <script src="~/lib/pwstrength/zxcvbn.js"></script>
        <script src="~/lib/peity/jquery.peity.min.js"></script>
        <script src="~/lib/sweetalert/dist/sweetalert.min.js"></script>
        <script src="~/lib/iCheck/icheck.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/intlTelInput.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js"></script>
    </environment>

    <script type="text/javascript">
        $(document).ready(function () {
            var options1 = {
                ui: {
                    container: "#pwd-container1",
                    showVerdictsInsideProgressBar: true,
                    viewports: { progress: ".pwstrength_viewport_progress" }
                },
                common: { debug: false }
            };
            $('.example1').pwstrength(options1);

            $("#securityQuestionsForm").steps({
                headerTag: "h1",
                bodyTag: "fieldset",
                transitionEffect: "fade",
                autoFocus: true,
                labels: {
                    cancel: "Cancelar",
                    current: "Actual",
                    finish: "Finalizar",
                    next: "Siguiente",
                    previous: "Anterior",
                    loading: "Cargando..."
                },
                onStepChanged: function (event, currentIndex, priorIndex) {
                    if (currentIndex === 1) {
                        var firstVal = $('#FirstQuestionId').val();
                        var secondVal = $('#SecondQuestionId').val();
                        
                        if (firstVal !== "" && secondVal === firstVal) {
                            $('#SecondQuestionId').val("");
                        }
                    } else if (currentIndex === 2) {
                        var firstVal = $('#FirstQuestionId').val();
                        var secondVal = $('#SecondQuestionId').val();
                        var thirdVal = $('#ThirdQuestionId').val();
                        
                        if ((firstVal !== "" && thirdVal === firstVal) || (secondVal !== "" && thirdVal === secondVal)) {
                            $('#ThirdQuestionId').val("");
                        }
                    }
                },
                onStepChanging: function (event, currentIndex, newIndex) {
                    if (currentIndex > newIndex) {
                        return true;
                    }
                    var form = $(this);
                    form.validate().settings.ignore = ":disabled,:hidden";
                    return form.valid();
                },
                onFinishing: function (event, currentIndex) {
                    var form = $(this);
                    form.validate().settings.ignore = ":disabled";
                    return form.valid();
                },
                onFinished: function (event, currentIndex) {
                    $(this).submit();
                }
            }).validate({
                errorPlacement: function (error, element) {
                    error.insertBefore(element);
                }
            });

            function updateSelectOptions() {
                var firstVal = $('#FirstQuestionId').val();
                var secondVal = $('#SecondQuestionId').val();

                $('#SecondQuestionId option').each(function () {
                    var optionVal = $(this).val();
                    if (optionVal !== "" && optionVal === firstVal) {
                        $(this).hide();
                    } else {
                        $(this).show();
                    }
                });

                $('#ThirdQuestionId option').each(function () {
                    var optionVal = $(this).val();
                    if (optionVal !== "" && (optionVal === firstVal || optionVal === secondVal)) {
                        $(this).hide();
                    } else {
                        $(this).show();
                    }
                });
            }

            $('#FirstQuestionId, #SecondQuestionId').on('change', updateSelectOptions);
            updateSelectOptions();

            function initializePeity() {
                $(".percentage-pie").each(function () {
                    var value = parseFloat($(this).data("value")) / 100;
                    $(this).peity("pie", {
                        fill: ["#1c84c6", "#f3f3f4"],
                        radius: 10
                    }).text(value + ", " + (1 - value)).change();
                });
            }
            initializePeity();

            const input = document.querySelector("#phone");

            const phoneInput = window.intlTelInput(input, {
                separateDialCode: true,
                initialCountry: "auto",
                geoIpLookup: function (callback) {
                    fetch("https://ipapi.co/json/")
                        .then((res) => res.json())
                        .then((data) => {
                            callback(data.country_code.toLowerCase());
                        })
                        .catch(() => {
                            callback("mx");
                        });
                },
                utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.19/js/utils.js"
            });

            input.addEventListener("blur", function () {
                if (!phoneInput.isValidNumber()) {
                    $("#phone-error").show();
                } else {
                    $("#phone-error").hide();
                }
            });

            $("#beneficiaryForm").submit(function (event) {
                if (!phoneInput.isValidNumber()) {
                    $("#phone-error").show();
                    event.preventDefault();
                } else {
                    $("#phone-error").hide();
                    input.value = phoneInput.getNumber();
                }
            });

            $("#beneficiaryPercentForm").on("submit", function(event) {
                var sum = 0;
                $("#beneficiaryTableBody input[name*='.Porcent']").each(function() {
                    var val = parseFloat($(this).val());
                    if (!isNaN(val)) {
                        sum += val;
                    }
                });

                if (sum !== 100) {
                    event.preventDefault();
                    alert("La suma de los porcentajes debe ser igual a 100. Actualmente suma: " + sum);
                }
            });

            $('.demo4').click(function () {
                var button = $(this);
                // Obtener los datos del botón
                var percent = parseFloat(button.data('percent'));
                var customerId = button.data('customer-id');
                var beneficiaryId = button.data('beneficiary-id');

                // Si el porcentaje es mayor que 0, no se permite eliminar
                if (percent > 0) {
                    swal("No se puede eliminar", "El beneficiario tiene un porcentaje asignado.", "error");
                    return;
                }

                // Mostrar SweetAlert para confirmación
                swal({
                        title: "¿Está seguro?",
                        text: "No será posible recuperar este beneficiario!",
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#DD6B55",
                        confirmButtonText: "Eliminar",
                        cancelButtonText: "Cancelar",
                        closeOnConfirm: false,
                        closeOnCancel: false
                    },
                    function (isConfirm) {
                        if (isConfirm) {
                            // Realizar la petición HTTP para eliminar el beneficiario.
                            $.ajax({
                                url: "/CustomerConfiguration/DeleteBeneficiary", // Asegúrate de que la URL sea correcta
                                type: "POST",
                                data: {
                                    customerId: customerId,
                                    beneficiaryId: beneficiaryId
                                },
                                success: function (response) {
                                    if (response.success) {
                                        swal({
                                            title: "¡Eliminado!",
                                            text: "El beneficiario ha sido eliminado.",
                                            type: "success",
                                            confirmButtonText: "OK"
                                        }, function () {
                                            window.location.href = "/Crypto/CustomerConfiguration?activeTab=ben";
                                        });
                                    } else {
                                        swal("Error", response.message || "No se pudo eliminar el beneficiario.", "error");
                                    }
                                },
                                error: function () {
                                    swal("Error", "No se pudo eliminar el beneficiario.", "error");
                                }
                            });
                        }
                        else {
                            swal("Cancelled", "El beneficiario no ha sido eliminado.", "error");
                        }
                    });
            });

            $("#addBeneficiary").click(function () {
                $("#modalTitle").text("Nuevo Beneficiario");
                $("#beneficiaryForm").attr("action", "/CustomerConfiguration/CreateBeneficiary");
                $("#beneficiaryId").val("");
                $("#name").val("");
                $("#apePaternal").val("");
                $("#apeMaternal").val("");
                $("#relationship").val("");
                $("#phone").val("");
                $("#saveChangesButton").text("Guardar");
            });

            // Capturar el botón de editar beneficiario
            $(document).on("click", ".edit-btn", function () {
                var beneficiaryId = $(this).data("id");
                var name = $(this).data("name");
                var apePaternal = $(this).data("ape-pat");
                var apeMaternal = $(this).data("ape-mat");
                var relationship = $(this).data("relationship");
                var phone = $(this).data("phone");

                $("#modalTitle").text("Editar Beneficiario");
                $("#beneficiaryForm").attr("action", "/CustomerConfiguration/UpdateBeneficiary");
                $("#beneficiaryId").val(beneficiaryId);
                $("#name").val(name);
                $("#apePaternal").val(apePaternal);
                $("#apeMaternal").val(apeMaternal);
                $("#relationship").val(relationship);
                $("#phone").val(phone);
                $("#saveChangesButton").text("Actualizar");
            });

            $('.i-checks').iCheck({
                checkboxClass: 'icheckbox_square-green',
                radioClass: 'iradio_square-green',
            });

            $('.demo5').click(function () {
                swal({
                        title: "¿Está seguro?",
                        text: "No será posible recuperar los documentos!",
                        type: "warning",
                        showCancelButton: true,
                        confirmButtonColor: "#DD6B55",
                        confirmButtonText: "Eliminar",
                        cancelButtonText: "Cancelar",
                        closeOnConfirm: false,
                        closeOnCancel: false
                    },
                    function (isConfirm) {
                        if (isConfirm) {
                            $.ajax({
                                url: '/CustomerConfiguration/DeleteCustomerPic',
                                type: 'DELETE',
                                data: {
                                    customerId: @Model.CustomerId,
                                },
                                success: function (response) {
                                    if (response.success) {
                                        swal({
                                            title: "¡Eliminado!",
                                            text: "Los documentos han sido eliminados.",
                                            type: "success",
                                            confirmButtonText: "OK"
                                        }, function () {
                                            window.location.href = "/Crypto/CustomerConfiguration?activeTab=subir-documentos";
                                        });
                                    } else {
                                        swal("Error", response.message || "No se pudo eliminar los documentos.", "error");
                                    }
                                },
                                error: function () {
                                    swal("Error", "No se pudo eliminar los documentos.", "error");
                                }
                            });
                        } else {
                            swal("Cancelled", "Your imaginary file is safe :)", "error");
                        }
                    });
            });

        });
    </script>
}



</body>
</html>
